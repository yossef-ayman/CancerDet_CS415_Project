# Ø§Ø³ØªØ¨Ø¯Ù„ FROM python:3.10-alpine
# ------------------------------------------------
# ğŸŸ¦ 1. Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù€ Slim (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ TensorFlow)
# ------------------------------------------------
FROM python:3.10-slim

# ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª)

WORKDIR /app

# ------------------------------------------------
# ğŸŸ¦ 2. ØªØ«Ø¨ÙŠØª Ø­Ø²Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù€ AI (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… apt-get Ù…Ø±Ø© Ø£Ø®Ø±Ù‰)
# ------------------------------------------------
# Ù†Ø£Ù…Ù„ Ø£Ù† ØªÙƒÙˆÙ† Ø®Ø·ÙˆØ© apt-get update Ø£Ø³Ø±Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©.
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    libgomp1 \
    # ... Ø£Ø¶Ù Ø£ÙŠ Ø­Ø²Ù… Ø£Ø®Ø±Ù‰ ØªØ­ØªØ§Ø¬Ù‡Ø§
    && apt-get clean && \
    rm -rf /var/lib/apt/lists/*
    
# ------------------------------------------------
# ğŸŸ¦ 3. ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† (Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ù…Ø¹ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹)
# ------------------------------------------------
COPY requirements.txt .

RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# ... (Ø¨Ø§Ù‚ÙŠ Dockerfile)
# ------------------------------------------------
# ğŸŸ¦ 4. Ø§Ù„Ø£Ù…Ø§Ù† ÙˆÙ†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ù…Ø¬Ù„Ø¯ AI)
# ------------------------------------------------
# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø¬Ø°Ø±ÙŠ (Ø£Ù…Ø§Ù† Ø£ÙØ¶Ù„)
RUN adduser -D appuser && \
    mkdir -p /app/AI/ && chown appuser:appuser -R /app/AI/
    
# Ù†Ø³Ø® ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
COPY --chown=appuser:appuser . .

USER appuser

EXPOSE 8000

# ------------------------------------------------
# ğŸŸ¦ 5. Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
# ------------------------------------------------
CMD ["gunicorn", "AI.server:app", \
     "--workers", "4", \
     "--worker-class", "uvicorn.workers.UvicornWorker", \
     "--bind", "0.0.0.0:8000"]